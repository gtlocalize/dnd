<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Silverpeak Chronicles - Claude DM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ú®</text></svg>">
    <!-- Shared Core CSS -->
    <link rel="stylesheet" href="/dnd/shared/campaign-base.css?v=1761137700">
    <!-- Campaign-Specific Theme -->
    <link rel="stylesheet" href="/dnd/campaigns/test-silverpeak/theme.css?v=1761137700">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Svelte Equipment Manager -->
    <link rel="stylesheet" href="/dnd/campaigns/test-silverpeak/svelte-dist/assets/index-BZa3awbx.css?v=1761137700">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner">üé≤</div>
            <h2>Connecting to Claude DM...</h2>
            <p>Initializing adventure systems</p>
        </div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="sandbox-banner" id="sandbox-banner" style="background: #dc2626; color: white; text-align: center; padding: 0.5rem; font-weight: bold; display: block;">
                üß™ SANDBOX MODE - API TESTING ENVIRONMENT üß™
            </div>
            <div class="header-content">
                <h1 class="logo">
                    <span class="logo-dice">üé≤</span>
                    <span class="logo-text">Claude DM</span>
                </h1>
                <div class="campaign-info">
                    <h2 id="campaign-title">Silverpeak Chronicles</h2>
                    <span id="session-counter">Chapter 1</span>
                </div>
                <!-- Svelte Header Controls -->
                <div id="header-controls-app"></div>
            </div>
        </header>

        <!-- Hidden placeholders for legacy JS -->
        <div style="display: none;">
            <span id="character-name"></span>
            <span id="character-race-class"></span>
            <span id="character-level"></span>
            <span id="character-initials"></span>
            <img id="character-image" src="" alt="">
            <span id="str-score"></span>
            <span id="str-mod"></span>
            <span id="dex-score"></span>
            <span id="dex-mod"></span>
            <span id="con-score"></span>
            <span id="con-mod"></span>
            <span id="int-score"></span>
            <span id="int-mod"></span>
            <span id="wis-score"></span>
            <span id="wis-mod"></span>
            <span id="cha-score"></span>
            <span id="cha-mod"></span>
            <span id="hp-value"></span>
            <span id="ac-value"></span>
            <div id="hp-bar"></div>
            <div id="status-effects"></div>
            <!-- Legacy game area elements -->
            <div id="game-log"></div>
            <textarea id="player-input"></textarea>
            <button id="mode-ic" data-mode="ic"></button>
            <button id="mode-dm-question" data-mode="dm-question"></button>
            <button id="mode-ooc" data-mode="ooc"></button>
            <button id="send-btn"></button>
        </div>

        <div class="main-content">
            <!-- Left Panel - Character Sheet (SVELTE WILL MOUNT HERE) -->
            <aside class="character-panel" id="svelte-character-panel">
                <!-- Svelte component will replace this content -->
            </aside>

            <!-- Center Panel - Game Area (SVELTE WILL MOUNT HERE) -->
            <main class="game-area" id="game-area-app">
                <!-- Svelte GameArea component will replace this content -->
            </main>

            <!-- Right Panel - Tools -->
            <aside class="tools-panel" id="tools-panel">
                <div class="tools-header">
                    <h3>Adventure Tools</h3>
                </div>
                <!-- Scene Generator - Svelte Component -->
                <div class="tools-full-width scene-section">
                    <div id="scene-generator-app"></div>
                </div>
                <!-- Inventory / Equipment / Spells - Svelte Component -->
                <div class="tools-full-width inventory-section">
                    <div id="equipment-app"></div>
                </div>
                <!-- Recent Rolls and Campaign Notes - Side by Side -->
                <div class="tools-row">
                    <div class="tools-half">
                        <div id="recent-rolls-app"></div>
                    </div>
                    <div class="tools-half">
                        <div id="campaign-notes-app"></div>
                    </div>
                </div>
            </aside>

            <!-- Combat Tracker - Replaces Tools Panel in Combat Mode -->
            <aside class="combat-panel" id="combat-panel" style="display: none;">
                <div id="combat-tracker-app"></div>
            </aside>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div id="character-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>‚öîÔ∏è Character Creation</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="character-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="char-name">Character Name</label>
                            <input type="text" id="char-name" placeholder="Enter character name">
                        </div>
                        <div class="form-group">
                            <label for="char-level">Level</label>
                            <input type="number" id="char-level" value="1" min="1" max="20">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="char-race">Race</label>
                            <select id="char-race">
                                <option value="human">Human</option>
                                <option value="elf">Elf</option>
                                <option value="dwarf">Dwarf</option>
                                <option value="halfling">Halfling</option>
                                <option value="dragonborn">Dragonborn</option>
                                <option value="gnome">Gnome</option>
                                <option value="half-elf">Half-Elf</option>
                                <option value="half-orc">Half-Orc</option>
                                <option value="tiefling">Tiefling</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="char-class">Class</label>
                            <select id="char-class">
                                <option value="fighter">Fighter</option>
                                <option value="wizard">Wizard</option>
                                <option value="rogue">Rogue</option>
                                <option value="cleric">Cleric</option>
                                <option value="ranger">Ranger</option>
                                <option value="paladin">Paladin</option>
                                <option value="barbarian">Barbarian</option>
                                <option value="bard">Bard</option>
                                <option value="druid">Druid</option>
                                <option value="monk">Monk</option>
                                <option value="sorcerer">Sorcerer</option>
                                <option value="warlock">Warlock</option>
                            </select>
                        </div>
                    </div>
                    <div class="abilities-section">
                        <h4>Ability Scores</h4>
                        <div class="abilities-grid">
                            <div class="ability-input">
                                <label for="str-input">Strength</label>
                                <input type="number" id="str-input" value="16" min="3" max="20">
                            </div>
                            <div class="ability-input">
                                <label for="dex-input">Dexterity</label>
                                <input type="number" id="dex-input" value="14" min="3" max="20">
                            </div>
                            <div class="ability-input">
                                <label for="con-input">Constitution</label>
                                <input type="number" id="con-input" value="15" min="3" max="20">
                            </div>
                            <div class="ability-input">
                                <label for="int-input">Intelligence</label>
                                <input type="number" id="int-input" value="12" min="3" max="20">
                            </div>
                            <div class="ability-input">
                                <label for="wis-input">Wisdom</label>
                                <input type="number" id="wis-input" value="13" min="3" max="20">
                            </div>
                            <div class="ability-input">
                                <label for="cha-input">Charisma</label>
                                <input type="number" id="cha-input" value="10" min="3" max="20">
                            </div>
                        </div>
                        <button type="button" id="roll-stats" class="btn-secondary">üé≤ Roll 4d6 Drop Lowest</button>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary modal-close">Cancel</button>
                        <button type="submit" class="btn-primary">Create Character</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- AI Provider Settings Modal -->
    <div id="ai-provider-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4>AI Dungeon Master Settings</h4>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="provider-selection">
                    <h5>Select AI Provider:</h5>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="ai-provider" value="claude" checked>
                            <span class="radio-custom"></span>
                            <div class="provider-info">
                                <strong>Claude (Sonnet 4.5)</strong>
                                <div class="provider-description">Excellent narrative, character consistency, creative storytelling</div>
                                <div class="provider-availability" id="claude-status">Loading...</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ai-provider" value="deepseek">
                            <span class="radio-custom"></span>
                            <div class="provider-info">
                                <strong>DeepSeek (Chat)</strong>
                                <div class="provider-description">Excellent reasoning, logical problem-solving, cost-effective</div>
                                <div class="provider-availability" id="deepseek-status">Loading...</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ai-provider" value="gpt4">
                            <span class="radio-custom"></span>
                            <div class="provider-info">
                                <strong>GPT-4 (Turbo)</strong>
                                <div class="provider-description">Balanced approach, consistent responses, steady pacing</div>
                                <div class="provider-availability" id="gpt4-status">Loading...</div>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary modal-close">Cancel</button>
                    <button type="button" id="save-ai-provider" class="btn-primary">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>About Claude DM</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">
                    <strong>Claude DM</strong> is an AI-powered D&D Campaign Manager that brings your adventures to life with intelligent narrative generation, real-time character management, and automated game state tracking.
                </p>

                <h3 style="color: var(--accent-gold); margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1rem;">Features</h3>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem; line-height: 1.8;">
                    <li>üé≤ Interactive dice rolling with automatic modifiers</li>
                    <li>ü§ñ Multi-AI DM support (Claude, DeepSeek, GPT-4)</li>
                    <li>üë• Three party members: Kira, Thorne, and Riven</li>
                    <li>üìä Automatic state tracking (HP, inventory, credits)</li>
                    <li>üé® AI-generated scene images</li>
                    <li>üíæ Persistent campaign history with rollback support</li>
                </ul>

                <h3 style="color: var(--accent-gold); margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1rem;">Message Modes</h3>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem; line-height: 1.8;">
                    <li><strong>‚öîÔ∏è In-Character</strong> - Canon actions that advance the story and update game state</li>
                    <li><strong>‚ùì DM Question</strong> - Ask questions without advancing the story</li>
                    <li><strong>üîß OOC</strong> - Non-canon testing and experimentation</li>
                </ul>

                <h3 style="color: var(--accent-gold); margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1rem;">Keyboard Shortcuts</h3>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem; line-height: 1.8;">
                    <li><kbd>Ctrl/Cmd + Enter</kbd> - Send action</li>
                    <li><kbd>Ctrl/Cmd + K</kbd> - Search (coming soon)</li>
                </ul>

                <p style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                    Powered by Claude Sonnet 4.5, DeepSeek, and GPT-4 APIs
                </p>
            </div>
        </div>
    </div>

    <!-- Shared Core JavaScript -->
    <script src="/dnd/shared/api-handler-base.js?v=1761137700"></script>
    <script src="/dnd/shared/campaign-base.js?v=1761137700"></script>

    <!-- Campaign-Specific Configuration -->
    <script src="/dnd/campaigns/test-silverpeak/campaign-config.js?v=1761137700"></script>

    <script>
        // Extract campaign ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const CAMPAIGN_ID = urlParams.get('campaign') || 'test-silverpeak';
        console.log('üìÅ Loading campaign:', CAMPAIGN_ID);

        // Store globally for API calls
        window.campaignId = CAMPAIGN_ID;

        // Debug and override functions
        document.addEventListener('DOMContentLoaded', function() {
            if (window.claudeAPI) {
                // Override sendMessage to debug
                const originalSendMessage = window.claudeAPI.sendMessage;
                window.claudeAPI.sendMessage = async function(playerMessage, isRollResult = false) {
                    console.log('=== DEBUGGING sendMessage ===');
                    console.log('Input:', playerMessage, isRollResult);
                    const result = await originalSendMessage.call(this, playerMessage, isRollResult);
                    console.log('Backend response:', result);
                    return result;
                };

                // Override parseRollRequest to fix the caching issue
                window.claudeAPI.parseRollRequest = function(rollRequest) {
                    console.log('parseRollRequest called with:', rollRequest);

                    // Handle current format: "Roll Constitution (DC 10) for quality of rest"
                    let match = rollRequest.match(/Roll\s+(.+?)\s+\(DC\s+(\d+)\)\s+(.+)/i);
                    if (!match) {
                        // Try without DC: "Roll Intelligence to decipher"
                        match = rollRequest.match(/Roll\s+(.+?)\s+to\s+(.+)/i);
                        if (match) {
                            match = [match[0], match[1], null, match[2]];
                        }
                    }
                    if (!match) {
                        // Try legacy format: "Roll Technology/Hacking (DC 15) to attempt something"
                        match = rollRequest.match(/Roll\s+(.+?)\s+\(DC\s+(\d+)\)\s+to\s+(.+)/i);
                    }
                    if (!match) {
                        // Handle Initiative rolls: "Roll Initiative for Kira, Thorne, Riven, and the Cult Fanatic"
                        const initMatch = rollRequest.match(/Roll\s+Initiative\s+for\s+(.+)/i);
                        if (initMatch) {
                            let participants = initMatch[1].trim();

                            // Filter out common enemy patterns - only keep party members
                            const partyMembers = ['Kira', 'Thorne', 'Riven'];
                            const participantList = participants.split(/,\s*(?:and\s+)?|(?:\s+and\s+)/);
                            const filteredParticipants = participantList.filter(name =>
                                partyMembers.some(pm => name.toLowerCase().includes(pm.toLowerCase()))
                            );

                            const description = filteredParticipants.length > 0
                                ? `for ${filteredParticipants.join(', ')}`
                                : `for ${participants}`; // Fallback to original if no match

                            const result = {
                                skill: 'Initiative',
                                dc: null,
                                description: description
                            };
                            console.log('parseRollRequest result (Initiative):', result);
                            return result;
                        }
                    }

                    if (match) {
                        const result = {
                            skill: match[1].trim(),
                            dc: match[2] ? parseInt(match[2]) : null,
                            description: match[3] ? match[3].trim() : rollRequest
                        };
                        console.log('parseRollRequest result:', result);
                        return result;
                    }

                    const fallback = {
                        skill: 'Unknown',
                        dc: null,
                        description: rollRequest
                    };
                    console.log('parseRollRequest fallback:', fallback);
                    return fallback;
                };
                console.log('Functions overridden for debugging');

                // Override handleRollRequest when game object becomes available
                const originalGameHandleRollRequest = setInterval(() => {
                    if (window.game && window.game.handleRollRequest) {
                        clearInterval(originalGameHandleRollRequest);

                        // Store the original method
                        const originalMethod = window.game.handleRollRequest;

                        window.game.handleRollRequest = function(rollRequest, narrative) {
                            console.log('OVERRIDDEN handleRollRequest called with:', rollRequest, narrative);

                            // Skip adding narrative to legacy log - Svelte already displayed it
                            // this.addLogEntry('dm', narrative);

                            // Use the Claude API's parseRollRequest method for consistency
                            const rollDetails = window.claudeAPI.parseRollRequest(rollRequest);

                            console.log('OVERRIDDEN Parsed roll details:', rollDetails);

                            // Dispatch event for Svelte to show roll prompt instead of using legacy showRollPrompt
                            window.dispatchEvent(new CustomEvent('showRollPrompt', {
                                detail: {
                                    rollDetails: rollDetails,
                                    rollRequest: rollRequest
                                }
                            }));

                            // Prevent the original method from being called by returning early
                            return;
                        };

                        // Also override the prototype method to catch any other instances
                        if (window.game.constructor && window.game.constructor.prototype) {
                            window.game.constructor.prototype.handleRollRequest = window.game.handleRollRequest;
                        }

                        console.log('handleRollRequest successfully overridden on both instance and prototype');
                    }
                }, 100);
            }
        });
    </script>

    <!-- Svelte Equipment Manager -->
    <script type="module" src="/dnd/campaigns/test-silverpeak/svelte-dist/assets/index-CWWjSjdx.js"></script>
</body>
</html>
